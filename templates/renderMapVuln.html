{% extends 'base.html' %}

{% block title %}Map of Asset Network (Vulnerabilities){% endblock %}

{% block header %}
<h1>Map of Asset Network: Highlighted Vulnerabilities</h1>
{% endblock %}

{% block content %}

<p>
    This page displays the asset network and highlights hosts marked as
    compromised or at-risk by the log filtering/analysis pipeline.
</p>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div id="map-container" style="display: flex; gap: 16px; margin-top: 20px; position: relative;">
    <!-- Graph container -->
    <div
        id="network"
        style="
            flex: 3;
            height: 75vh;
            border: 1px solid #ccc;
            border-radius: 6px;
            position: relative;
        "
    >
        <!-- network drawing goes here (legend moved outside to avoid being removed) -->
    </div>

    <!-- Legend overlay (moved out of #network so vis-network won't remove it) -->
    <div
        id="legend"
        style="
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            font-size: 0.8rem;
            border: 1px solid #bbb;
            z-index: 9999;
            pointer-events: auto;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        "
    >
        <strong>Edge Legend</strong><br /><br />
        <div style="font-size:0.85rem;color:#222">(Colored edges show relation types)</div>
        <hr style="margin:8px 0" />
        <strong>Vulnerability Legend</strong>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <span style="display:inline-block;width:16px;height:12px;background:#ef4444;border:1px solid #111"></span>
            <span>Critical / Compromised</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <span style="display:inline-block;width:16px;height:12px;background:#f59e0b;border:1px solid #111"></span>
            <span>High</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <span style="display:inline-block;width:16px;height:12px;background:#fbbf24;border:1px solid #111"></span>
            <span>Medium / At Risk</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <span style="display:inline-block;width:16px;height:12px;background:#8b5cf6;border:1px solid #4c1d95;border-radius:2px"></span>
            <span>Peripheral / Perimeter Affected</span>
        </div>
    </div>

    <!-- Info box -->
    <div
        id="node-info"
        style="
            flex: 1;
            height: 75vh;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 12px;
            font-size: 0.9rem;
            overflow-y: auto;
            background: #f9fafb;
        "
    >
        <h3 style="margin-top: 0">Node Info</h3>
        <p>Click a node in the graph to pin its details here.</p>
    </div>
</div>

<!-- vis-network CDN -->
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="{{ url_for('static', filename='renderMapVuln.js') }}"></script>

{% endblock %}
