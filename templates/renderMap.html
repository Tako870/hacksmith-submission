{% extends 'base.html' %}

{% block title %}Map of Asset Network{% endblock %}

{% block header %}
<h1>Map of Asset Network</h1>
{% endblock %}

{% block content %}

<p>
	This page will display a visual representation of the asset network based
	on the uploaded JSON map. Vulnerabilities won't be highlighted on this base view.
</p>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
	{% for category, message in messages %}
	  <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
		{{ message }}
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	  </div>
	{% endfor %}
  {% endif %}
{% endwith %}

<div id="map-container" style="display: flex; gap: 16px; margin-top: 20px">
	<!-- Graph container -->
	<div
		id="network"
		style="
			flex: 3;
			height: 75vh;
			border: 1px solid #ccc;
			border-radius: 6px;
			position: relative;
		"
	>
		<!-- Legend overlay -->
		<div
			id="legend"
			style="
				position: absolute;
				top: 10px;
				left: 10px;
				padding: 10px;
				background: rgba(255, 255, 255, 0.85);
				border-radius: 6px;
				font-size: 0.8rem;
				border: 1px solid #bbb;
			"
		>
			<strong>Edge Legend</strong><br /><br />
			<div style="font-size:0.85rem;color:#222">(Colored edges show relation types)</div>
		</div>
	</div>

	<!-- Info box -->
	<div
		id="node-info"
		style="
			flex: 1;
			height: 75vh;
			border: 1px solid #ccc;
			border-radius: 6px;
			padding: 12px;
			font-size: 0.9rem;
			overflow-y: auto;
			background: #f9fafb;
		"
	>
		<h3 style="margin-top: 0">Node Info</h3>
		<p>Click a node in the graph to pin its details here.</p>
	</div>
</div>

<!-- vis-network CDN -->
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
	fetch("/api/assetmap")
		.then((res) => res.json())
		.then((graph) => {
			// ===== Edge color dictionary =====
			const edgeColors = {
				dmz_exposed: "#ef4444",
				app_backend: "#3b82f6",
				db_backend: "#10b981",
				admin_on: "#f59e0b",
				local_admin_on: "#6366f1",
				member_of: "#8b5cf6",
				interactive_logon: "#14b8a6",
				data_access: "#f43f5e",
			};

			const rawNodes = graph.nodes || [];
			const rawEdges = graph.edges || [];

			const visNodes = rawNodes.map((n) => {
				// Default monotone color
				let color = "#bdbdbd";
				let shape = "dot";
				let size = 18;

				if (n.type === "user") {
					color = "#9e9e9e";
					shape = "diamond";
					size = 16;
				} else if (n.type === "group") {
					color = "#8b8b8b";
					shape = "hexagon";
					size = 20;
				}

				let label = n.name || n.id;
				if (n.type === "host" && n.ip) label += "\n" + n.ip;
				if (n.type === "user" && n.sam_account_name) label += "\n(" + n.sam_account_name + ")";

				return {
					id: n.id,
					label,
					color: { background: color, border: "#111" },
					shape,
					size,
					font: { color: "#111", size: 12, multi: true },
					raw: n,
				};
			});

			const visEdges = rawEdges.map((e, idx) => ({
				id: "e-" + idx,
				from: e.source,
				to: e.target,
				arrows: "to",
				color: {
					color: edgeColors[e.relation] || "#999",
					highlight: edgeColors[e.relation] || "#999",
					inherit: false,
				},
				width: 2,
				smooth: { type: "dynamic" },
			}));

			const container = document.getElementById("network");
			const data = {
				nodes: new vis.DataSet(visNodes),
				edges: new vis.DataSet(visEdges),
			};

			const options = {
				interaction: { hover: true, navigationButtons: true, keyboard: true },
				physics: { stabilization: true, barnesHut: { gravitationalConstant: -3000, springLength: 150 } },
			};

			const network = new vis.Network(container, data, options);

			const infoBox = document.getElementById("node-info");

			function renderInfo(node) {
				if (!node) {
					infoBox.innerHTML = `<h3>Node Info</h3><p>Click a node in the graph to pin its details here.</p>`;
					return;
				}

				const n = node.raw;
				const type = n.type || "unknown";
				const name = n.name || node.id;
				const ipOrAcct = n.ip || n.sam_account_name || "N/A";

				infoBox.innerHTML = `
		<h3>Node Info</h3>
		<ul>
		  <li><strong>Type:</strong> ${type}</li>
		  <li><strong>Name:</strong> ${name}</li>
		  <li><strong>IP / Account:</strong> ${ipOrAcct}</li>
		  <li><strong>Zone / Department:</strong> ${n.zone || n.department || "N/A"}</li>
		  <li><strong>Criticality:</strong> ${n.criticality || "N/A"}</li>
		</ul>
	  `;
			}

			network.on("click", (params) => {
				if (params.nodes.length > 0) {
					const nodeId = params.nodes[0];
					const node = visNodes.find((n) => n.id === nodeId);
					renderInfo(node);
				}
			});
		});
</script>

{% endblock %}

